name: Auto Version Bump
run-name: "[Automated] Version Bump for claude-plugins"

on:
  pull_request:
    types: [closed]
    branches: [main]

  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      target:
        description: "Target to bump (plugin name or 'all')"
        required: true
        default: "all"
        type: string

jobs:
  version-bump:
    runs-on: infra-non-prod-dind-low
    permissions:
      contents: write
      id-token: write
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.CICD_APP_ID }}
          private-key: ${{ secrets.CICD_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Determine version bump type from PR labels
        id: bump_type
        run: |
          echo "## Version Bump Detection" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            bump_type="${{ github.event.inputs.version_type }}"
            echo "type=$bump_type" >> $GITHUB_OUTPUT
            echo "**Source:** Manual workflow dispatch" >> $GITHUB_STEP_SUMMARY
            echo "**Bump type:** $bump_type" >> $GITHUB_STEP_SUMMARY
          else
            labels='${{ toJson(github.event.pull_request.labels.*.name) }}'
            echo "**Source:** PR labels from #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
            echo "**PR Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
            echo "**Labels found:** $labels" >> $GITHUB_STEP_SUMMARY

            if echo "$labels" | grep -q "version:major"; then
              echo "type=major" >> $GITHUB_OUTPUT
              echo "**Bump type:** major (breaking changes)" >> $GITHUB_STEP_SUMMARY
            elif echo "$labels" | grep -q "version:minor"; then
              echo "type=minor" >> $GITHUB_OUTPUT
              echo "**Bump type:** minor (new features)" >> $GITHUB_STEP_SUMMARY
            elif echo "$labels" | grep -q "version:patch"; then
              echo "type=patch" >> $GITHUB_OUTPUT
              echo "**Bump type:** patch (bug fixes)" >> $GITHUB_STEP_SUMMARY
            else
              echo "type=minor" >> $GITHUB_OUTPUT
              echo "**Bump type:** minor (default - no version label found)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Detect changed plugins and bump versions
        id: bump_versions
        run: |
          python3 - <<'PYEOF'
          import json
          import glob
          import subprocess
          import os

          bump_type = "${{ steps.bump_type.outputs.type }}"
          event_name = "${{ github.event_name }}"
          dispatch_target = "${{ github.event.inputs.target }}" if event_name == "workflow_dispatch" else ""
          merge_sha = "${{ github.event.pull_request.merge_commit_sha }}" if event_name != "workflow_dispatch" else ""

          def bump(version, bump_type):
              major, minor, patch = map(int, version.split('.'))
              if bump_type == 'major':
                  return f"{major + 1}.0.0"
              elif bump_type == 'minor':
                  return f"{major}.{minor + 1}.0"
              else:
                  return f"{major}.{minor}.{patch + 1}"

          # Detect changed files from the merged PR
          changed_files = []
          if merge_sha:
              result = subprocess.run(
                  ['git', 'diff', '--name-only', f'{merge_sha}^', merge_sha],
                  capture_output=True, text=True
              )
              changed_files = [f.strip() for f in result.stdout.strip().split('\n') if f.strip()]

          # Determine which plugins changed
          changed_plugins = set()
          marketplace_changed = False

          if event_name == "workflow_dispatch":
              if dispatch_target == "all":
                  # Bump everything
                  marketplace_changed = True
                  for path in glob.glob('plugins/*/.claude-plugin/plugin.json'):
                      plugin_name = path.split('/')[1]
                      changed_plugins.add(plugin_name)
              else:
                  # Bump specific plugin
                  plugin_path = f'plugins/{dispatch_target}/.claude-plugin/plugin.json'
                  if os.path.exists(plugin_path):
                      changed_plugins.add(dispatch_target)
                  else:
                      marketplace_changed = True
          else:
              for f in changed_files:
                  if f.startswith('plugins/'):
                      parts = f.split('/')
                      if len(parts) >= 2:
                          changed_plugins.add(parts[1])
                  else:
                      marketplace_changed = True

          # Load marketplace.json
          with open('.claude-plugin/marketplace.json', 'r') as f:
              marketplace = json.load(f)

          summary_lines = []
          tags = []
          old_marketplace_version = marketplace['version']

          # Bump marketplace version if root files changed
          if marketplace_changed:
              new_marketplace_version = bump(old_marketplace_version, bump_type)
              marketplace['version'] = new_marketplace_version
              summary_lines.append(f"**Marketplace:** {old_marketplace_version} -> {new_marketplace_version}")
              tags.append(f"v{new_marketplace_version}")
          else:
              summary_lines.append(f"**Marketplace:** {old_marketplace_version} (unchanged)")

          # Bump each changed plugin
          for plugin_name in sorted(changed_plugins):
              plugin_json_path = f'plugins/{plugin_name}/.claude-plugin/plugin.json'
              if not os.path.exists(plugin_json_path):
                  continue

              with open(plugin_json_path, 'r') as f:
                  plugin = json.load(f)

              old_version = plugin['version']
              new_version = bump(old_version, bump_type)
              plugin['version'] = new_version

              with open(plugin_json_path, 'w') as f:
                  json.dump(plugin, f, indent=2)
                  f.write('\n')

              # Sync version to marketplace.json plugin entry
              for entry in marketplace.get('plugins', []):
                  if entry['name'] == plugin_name:
                      entry['version'] = new_version

              summary_lines.append(f"**{plugin_name}:** {old_version} -> {new_version}")
              tags.append(f"{plugin_name}/v{new_version}")

          # Write updated marketplace.json
          with open('.claude-plugin/marketplace.json', 'w') as f:
              json.dump(marketplace, f, indent=2)
              f.write('\n')

          # Write outputs
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"marketplace_version={marketplace['version']}\n")
              f.write(f"tags={','.join(tags)}\n")
              f.write(f"has_changes={'true' if (marketplace_changed or changed_plugins) else 'false'}\n")

          # Write summary
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write("## Version Bumps\n")
              for line in summary_lines:
                  f.write(f"{line}\n\n")
              if tags:
                  f.write(f"**Tags:** {', '.join(tags)}\n")

          PYEOF

      - name: Get GitHub App User ID
        if: steps.bump_versions.outputs.has_changes == 'true'
        id: get-user-id
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const result = await github.rest.users.getByUsername({
              username: '${{ steps.app-token.outputs.app-slug }}[bot]'
            })
            return result.data.id

      - name: Config git
        if: steps.bump_versions.outputs.has_changes == 'true'
        run: |
          git config user.name "${{ steps.app-token.outputs.app-slug }}[bot]"
          git config user.email "${{ steps.get-user-id.outputs.result }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com"

      - name: Commit and tag version bumps
        if: steps.bump_versions.outputs.has_changes == 'true'
        run: |
          echo "## Git Operations" >> $GITHUB_STEP_SUMMARY

          git add .claude-plugin/marketplace.json
          git add plugins/*/.claude-plugin/plugin.json 2>/dev/null || true

          commit_message="[Automated] chore: bump versions"
          git commit -m "$commit_message"

          # Create tags
          IFS=',' read -ra TAGS <<< "${{ steps.bump_versions.outputs.tags }}"
          for tag in "${TAGS[@]}"; do
            git tag "$tag"
            echo "**Tag created:** $tag" >> $GITHUB_STEP_SUMMARY
          done

          git push origin main
          for tag in "${TAGS[@]}"; do
            git push origin "$tag"
          done

          echo "**Status:** Successfully pushed commit and tags" >> $GITHUB_STEP_SUMMARY

      - name: Create releases
        if: steps.bump_versions.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const tags = '${{ steps.bump_versions.outputs.tags }}'.split(',').filter(Boolean);
            const prTitle = '${{ github.event.pull_request.title }}' || 'Manual dispatch';
            const prNumber = '${{ github.event.pull_request.number }}' || 'N/A';

            for (const tag of tags) {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: tag,
                body: `## Changes\nMerged PR: ${prTitle} #${prNumber}\n\n**Full Changelog**: https://github.com/${context.repo.owner}/${context.repo.repo}/compare/main~1...${tag}`,
                draft: false,
                prerelease: false,
              });
            }

      - name: Workflow Summary
        if: always()
        run: |
          echo "## Workflow Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Key | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | ${{ github.repository }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bump Type | ${{ steps.bump_type.outputs.type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tags | ${{ steps.bump_versions.outputs.tags }} |" >> $GITHUB_STEP_SUMMARY
